<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no">
    <title>Debts App</title>
    <meta name="color-scheme" content="light dark">

    <link rel="stylesheet" href="assets/fontawesome/css/all.min.css">

    <link rel="manifest" href="/manifest.webmanifest">

    <!-- Цвет статус-бара и системных UI (Android + Chrome iOS) -->
    <meta name="theme-color" content="#141821" media="(prefers-color-scheme: dark)">
    <meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)">

    <!-- iOS PWA full-screen -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <!-- Варианты: default / black / black-translucent. Для Dynamic Island чаще лучше translucent -->
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <meta name="apple-mobile-web-app-title" content="Debts App">

    <!-- iOS иконки -->
    <link rel="apple-touch-icon" href="icons/apple-touch-icon-180.png" sizes="180x180">
    <link rel="apple-touch-icon" href="icons/apple-touch-icon-167.png" sizes="167x167">
    <link rel="apple-touch-icon" href="icons/apple-touch-icon-152.png" sizes="152x152">
    <link rel="apple-touch-icon" href="icons/apple-touch-icon-120.png" sizes="120x120">
    <style>
        :root {
            --primary: #4285F4;
            --primary-light: #8AB4F8;
            --background: #FFFFFF;
            --surface: #FFFFFF;
            --text-primary: #202124;
            --text-secondary: #5F6368;
            --text-tertiary: #9AA0A6;
            --border: #DADCE0;
            --border-light: #E8EAED;
            --danger: #EA4335;
            --warning: #FBBC04;
            --success: #34A853;
            --income-bg: rgba(52, 168, 83, 0.08);
            --income-border: rgba(52, 168, 83, 0.2);
            --calculator-bg: rgba(66, 133, 244, 0.08);
            --calculator-border: #4285F4;
            --planned-bg: rgba(66, 133, 244, 0.05);
            --radius: 16px;
            --shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --primary: #8AB4F8;
                --primary-light: #AECBFA;
                --background: #202124;
                --surface: #303134;
                --text-primary: #E8EAED;
                --text-secondary: #BDC1C6;
                --text-tertiary: #9AA0A6;
                --border: #5F6368;
                --border-light: #3C4043;
                --danger: #F28B82;
                --warning: #FDCF6D;
                --success: #81C995;
                --income-bg: rgba(129, 201, 149, 0.15);
                --income-border: rgba(129, 201, 149, 0.3);
                --calculator-bg: rgba(138, 180, 248, 0.15);
                --planned-bg: rgba(138, 180, 248, 0.1);
                --shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
            }
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Google Sans', 'Segoe UI', Roboto, -apple-system, sans-serif;
        }

        body {
            background: var(--background);
            color: var(--text-primary);
            padding: 0;
            min-height: 100vh;
            font-size: 15px;
            font-weight: 400;
            line-height: 1.4;
        }

        .container {
            max-width: 480px;
            margin: 0 auto;
        }

        /* Верхняя часть */
        .top-section {
            position: sticky;
            top: 0;
            z-index: 10;
            background: var(--background);
            border-bottom: 1px solid var(--border-light);
            backdrop-filter: blur(10px);
            background: rgba(var(--background-rgb), 0.92);
            margin-top: 40px;
        }

        .header {
            padding: 24px 20px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Прогресс погашения кредита */
        .debt-progress {
            margin: 0 20px 16px;
            padding: 16px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }

        .debt-progress-top {
            display: flex;
            align-items: baseline;
            justify-content: space-between;
            gap: 12px;
            margin-bottom: 10px;
        }

        .debt-progress-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .debt-progress-percent {
            font-size: 18px;
            font-weight: 700;
            color: var(--primary);
            white-space: nowrap;
        }

        .debt-progress-bar {
            height: 10px;
            border-radius: 999px;
            background: rgba(66, 133, 244, 0.12);
            border: 1px solid var(--border-light);
            overflow: hidden;
            margin-bottom: 12px;
        }

        .debt-progress-bar > div {
            height: 100%;
            width: 0%;
            background: var(--primary);
            border-radius: 999px;
            transition: width 0.35s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .debt-progress-metrics {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .debt-metric {
            padding: 10px 12px;
            border-radius: 12px;
            background: rgba(0, 0, 0, 0.02);
            border: 1px solid var(--border-light);
        }

        @media (prefers-color-scheme: dark) {
            .debt-metric {
                background: rgba(255, 255, 255, 0.04);
            }
        }

        .debt-metric-label {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-tertiary);
            margin-bottom: 4px;
        }

        .debt-metric-value {
            font-size: 16px;
            font-weight: 650;
            color: var(--text-primary);
            white-space: nowrap;
        }

        .debt-metric-value.current {
            color: var(--danger);
        }

        .date-info {
            flex: 1;
        }

        .date-text {
            font-size: 20px;
            font-weight: 500;
            color: var(--text-primary);
            letter-spacing: -0.01em;
        }

        .date-number {
            color: var(--primary);
            font-weight: 600;
        }

        .calculator-toggle {
            width: 48px;
            height: 48px;
            border-radius: 24px;
            border: 1px solid var(--border);
            background: var(--surface);
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 20px;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            margin-left: 12px;
            flex-shrink: 0;
        }

        .calculator-toggle.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            box-shadow: 0 1px 3px rgba(66, 133, 244, 0.3);
        }

        /* Панель калькулятора */
        .calculator-panel {
            padding: 20px;
            display: none;
            border-bottom: 1px solid var(--border-light);
            padding-top: 0;
        }

        .calculator-panel.active {
            display: block;
        }

        .calculator-summary {
            font-size: 17px;
            font-weight: 500;
            color: var(--text-primary);
            padding: 16px;
            background: var(--surface);
            border-radius: var(--radius);
            border: 1px solid var(--border);
            text-align: center;
            margin-bottom: 16px;
            box-shadow: var(--shadow);
        }

        .calculator-summary span {
            color: var(--primary);
            font-weight: 600;
        }

        .calculator-presets {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 16px;
        }

        .preset-btn {
            padding: 12px 16px;
            border-radius: var(--radius);
            border: 1px solid var(--border);
            background: var(--surface);
            color: var(--text-primary);
            font-weight: 500;
            font-size: 15px;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            text-align: center;
        }

        .calculator-actions {
            display: flex;
            gap: 10px;
        }

        .calculator-btn {
            padding: 12px 24px;
            border-radius: var(--radius);
            border: none;
            font-weight: 500;
            font-size: 15px;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            flex: 1;
        }

        .calculator-btn.primary {
            background: var(--primary);
            color: white;
            box-shadow: 0 1px 2px rgba(66, 133, 244, 0.3);
        }

        .calculator-btn.secondary {
            background: var(--surface);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        /* Список платежей */
        .payments {
            padding: 8px 0 24px;
        }

        /* Заголовок месяца */
        .month-header {
            padding: 24px 20px 12px 20px;
            position: sticky;
            top: 0;
            z-index: 5;
            background: var(--background);
        }

        .month-title {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-light);
            position: relative;
        }

        .month-title::before {
            content: '';
            position: absolute;
            left: 0;
            bottom: -1px;
            width: 40px;
            height: 2px;
            background: var(--primary);
            border-radius: 1px;
        }

        .payment-group {
            padding: 0 20px;
        }

        .payment {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 18px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--shadow);
        }

        .payment.calculator-selected {
            border-color: var(--primary);
            background: var(--calculator-bg);
            box-shadow: 0 2px 8px rgba(66, 133, 244, 0.15);
        }

        .payment.income {
            background: var(--income-bg);
            border-color: var(--income-border);
        }

        .payment.planned {
            background: var(--planned-bg);
            opacity: 0.7;    /* сильнее мутность */
            animation: none; /* отключаем fadeIn, чтобы не ломал opacity */
        }

        .payment.paid {
            opacity: 0.2;
        }

        .payment.paid .payment-name,
        .payment.paid .payment-amount {
            text-decoration: line-through;
        }

        .payment-info {
            flex: 1;
            min-width: 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .payment-details {
            flex: 1;
            min-width: 0;
        }

        .payment-name {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 6px;
            line-height: 1.3;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .payment-meta {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .payment-date {
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 400;
            white-space: nowrap;
        }

        .payment-days {
            font-size: 13px;
            font-weight: 500;
            padding: 3px 10px;
            border-radius: 10px;
            background: rgba(66, 133, 244, 0.1);
            color: var(--primary);
            white-space: nowrap;
        }

        .payment-amount-container {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 8px;
            margin-left: 8px;
            flex-shrink: 0;
        }

        .payment-amount {
            font-size: 17px;
            font-weight: 600;
            white-space: nowrap;
            color: var(--text-primary);
        }

        .payment-amount.high {
            color: var(--danger);
        }

        .payment-amount.income {
            color: var(--success);
        }

        /* Кнопки действий - вертикально */
        .payment-actions {
            display: flex;
            flex-direction: row; /* было column */
            gap: 8px;            /* можно чуть больше расстояние */
            margin-left: 8px;
            flex-shrink: 0;
        }

        .action-btn {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: var(--surface);
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .action-btn.planned {
            background: rgba(66, 133, 244, 0.1);
            /*color: var(--primary);*/
            /*border-color: var(--primary);*/
            background: var(--success);
            color: white;
            border-color: var(--success);
        }

        .action-btn.paid {
            background: var(--success);
            color: white;
            border-color: var(--success);
        }

        .calculator-mode .action-btn {
            display: none;
        }

        /* Плашка дохода */
        .income-amount {
            font-size: 14px;
            font-weight: 500;
            color: var(--success);
            background: rgba(52, 168, 83, 0.1);
            padding: 4px 12px;
            border-radius: 10px;
            white-space: nowrap;
        }

        /* Чекбокс калькулятора */
        .calculator-checkbox {
            width: 22px;
            height: 22px;
            border-radius: 6px;
            border: 2px solid var(--border);
            margin-right: 14px;
            flex-shrink: 0;
            display: none;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        .calculator-checkbox.checked {
            background: var(--primary);
            border-color: var(--primary);
        }

        .calculator-checkbox.checked::after {
            content: '';
            width: 6px;
            height: 10px;
            border: solid white;
            border-width: 0 2px 2px 0;
            transform: rotate(45deg);
            position: absolute;
            top: 4px;
            left: 7px;
        }

        .calculator-mode .calculator-checkbox {
            display: flex;
        }

        .payment.income .calculator-checkbox {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .payment.income .calculator-checkbox.checked {
            background: var(--border);
            border-color: var(--border);
        }

        /* Анимации */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(8px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .payment {
            animation: fadeIn 0.3s ease forwards;
            animation-delay: calc(var(--item-index, 0) * 0.05s);
            opacity: 0;
        }

        .month-header {
            animation: fadeIn 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="top-section">
            <div class="header">
                <div class="date-info">
                    <div class="date-text">
                        <span class="date-number" id="currentDay">10</span> декабря
                    </div>
                </div>
                <button class="calculator-toggle" id="calculatorToggle" title="Режим калькулятора">
                    <i class="fas fa-calculator"></i>
                </button>
            </div>

            <div class="debt-progress" id="debtProgress">
                <div class="debt-progress-top">
                    <div class="debt-progress-title">Прогресс погашения</div>
                    <div class="debt-progress-percent" id="debtPercent">0%</div>
                </div>

                <div class="debt-progress-bar" aria-hidden="true">
                    <div id="debtBar"></div>
                </div>

                <div class="debt-progress-metrics">
                    <div class="debt-metric">
                        <div class="debt-metric-label">Начальный долг</div>
                        <div class="debt-metric-value" id="debtInitial">—</div>
                    </div>
                    <div class="debt-metric">
                        <div class="debt-metric-label">Текущий долг</div>
                        <div class="debt-metric-value current" id="debtCurrent">—</div>
                    </div>
                </div>
            </div>

            <div class="calculator-panel" id="calculatorPanel">
                <div class="calculator-summary" id="calculatorSummary">
                    <!-- Здесь будет сумма -->
                </div>

                <div class="calculator-presets">
                    <button class="preset-btn" data-days="15">15 дн</button>
                    <button class="preset-btn" data-days="30">1 мес</button>
                    <button class="preset-btn" data-days="45">45 дн</button>
                    <button class="preset-btn" data-days="60">2 мес</button>
                </div>

                <div class="calculator-actions" style="display: none;">
                    <button class="calculator-btn secondary" id="clearSelection">Очистить</button>
                    <button class="calculator-btn primary" id="exitCalculator">Готово</button>
                </div>
            </div>
        </div>

        <div class="payments" id="paymentsList">
            <!-- Платежи сгруппированы по месяцам -->
        </div>
    </div>

    <script>
        // Прогресс погашения кредита
        const DEBT_INITIAL = 1_033_000;
        const DEBT_CURRENT = 529_430;

        // Ваши платежи
        const paymentTemplates = [
            { id: 'tbank', name: "Т Банк Кредитка", day: 4, amount: 4300 },
            { id: 'yandex_1', name: "Яндекс Кредит", day: 19, amount: 17819 },
            { id: 'kvartplata', name: "Квартплата", day: 28, amount: 40000 },
            { id: 'sber_credit', name: "Сбер Кредитка", day: 30, amount: 14300 },
            { id: 'avans', name: "Аванс", day: 27, amount: 0, income: true },
            { id: 'salary', name: "Зарплата", day: 12, amount: 0, income: true }
        ];

        const today = new Date();
        today.setHours(0, 0, 0, 0); // чтобы дниDiff считались ровно по датам

        const endDate = new Date(today);
        endDate.setDate(endDate.getDate() + 60);

        const monthNames = [
            'января', 'февраля', 'марта', 'апреля', 'мая', 'июня',
            'июля', 'августа', 'сентября', 'октября', 'ноября', 'декабря'
        ];

        const monthTitles = [
            'январь', 'февраль', 'март', 'апрель', 'май', 'июнь',
            'июль', 'август', 'сентябрь', 'октябрь', 'ноябрь', 'декабрь'
        ];

        const monthShortNames = [
            'янв', 'фев', 'мар', 'апр', 'мая', 'июн',
            'июл', 'авг', 'сен', 'окт', 'ноя', 'дек'
        ];

        // Обновляем дату
        document.getElementById('currentDay').textContent = today.getDate();

        function clamp01(value) {
            return Math.min(1, Math.max(0, value));
        }

        function formatRub(amount) {
            return amount.toLocaleString('ru-RU') + ' ₽';
        }

        function updateDebtProgress() {
            const paidRatio = clamp01((DEBT_INITIAL - DEBT_CURRENT) / DEBT_INITIAL);
            const percent = Math.round(paidRatio * 1000) / 10; // 1 знак после запятой

            const percentText = Number.isInteger(percent) ? `${percent}%` : `${percent.toFixed(1)}%`;

            const elPercent = document.getElementById('debtPercent');
            const elBar = document.getElementById('debtBar');
            const elInitial = document.getElementById('debtInitial');
            const elCurrent = document.getElementById('debtCurrent');

            if (elPercent) elPercent.textContent = percentText;
            if (elBar) elBar.style.width = `${paidRatio * 100}%`;
            if (elInitial) elInitial.textContent = formatRub(DEBT_INITIAL);
            if (elCurrent) elCurrent.textContent = formatRub(DEBT_CURRENT);
        }

        updateDebtProgress();

        // Состояния
        let paymentStates = {};
        let calculatorMode = false;
        let selectedPayments = new Set();
        let currentPayments = [];

        // Загружаем сохранённые состояния
        try {
            const saved = localStorage.getItem('paymentStates');
            if (saved) {
                paymentStates = JSON.parse(saved);
            }
        } catch (e) {
            console.log('Не удалось загрузить сохранённые состояния');
        }

        // Сохраняем состояния
        function savePaymentStates() {
            localStorage.setItem('paymentStates', JSON.stringify(paymentStates));
        }

        // Вспомогательные функции
        function getPaymentDate(day, monthOffset = 0) {
            const date = new Date(today);
            date.setMonth(date.getMonth() + monthOffset);
            date.setDate(day);
            return date;
        }

        function getDaysDiff(date) {
            const diff = date - today;
            return Math.floor(diff / (1000 * 60 * 60 * 24));
        }

        function formatAmount(amount) {
            return amount.toLocaleString('ru-RU') + ' ₽';
        }

        function formatDate(date) {
            const day = date.getDate();
            const month = monthShortNames[date.getMonth()];
            return `${day} ${month}`;
        }

        function getDaysText(days) {
            if (days === 0) return 'Сегодня';
            if (days === 1) return 'Завтра';
            return `${days} дн`;
        }

        function getCountWord(count) {
            if (count % 10 === 1 && count % 100 !== 11) return 'платеж';
            if (count % 10 >= 2 && count % 10 <= 4 && (count % 100 < 10 || count % 100 >= 20)) return 'платежа';
            return 'платежей';
        }

        // Генерация всех платежей на 60 дней вперёд с группировкой по месяцам
        function generateAllPayments() {
            const result = [];

            paymentTemplates.forEach(template => {
                let monthOffset = 0;

                while (true) {
                    const date = getPaymentDate(template.day, monthOffset);

                    if (date > endDate) {
                        break;
                    }

                    if (getDaysDiff(date) >= 0) {
                        result.push({
                            id: `${template.id}_${monthOffset}`,
                            name: template.name,
                            date: date,
                            amount: template.amount,
                            income: template.income || false,
                            daysDiff: getDaysDiff(date),
                            monthOffset: monthOffset,
                            monthYear: `${date.getMonth()}-${date.getFullYear()}`,
                            monthName: monthTitles[date.getMonth()]
                        });
                    }

                    monthOffset++;
                }
            });

            return result.sort((a, b) => a.date - b.date);
        }

        // Группировка платежей по месяцам
        function groupPaymentsByMonth(payments) {
            const groups = {};

            payments.forEach(payment => {
                if (!groups[payment.monthYear]) {
                    groups[payment.monthYear] = {
                        monthName: payment.monthName,
                        year: payment.date.getFullYear(),
                        month: payment.date.getMonth(),
                        payments: []
                    };
                }
                groups[payment.monthYear].payments.push(payment);
            });

            // Сортируем месяцы по дате
            return Object.values(groups).sort((a, b) => {
                if (a.year !== b.year) return a.year - b.year;
                return a.month - b.month;
            });
        }

        // Обновление калькулятора
        function updateCalculator() {
            const selectedCount = selectedPayments.size;
            const totalAmount = Array.from(selectedPayments).reduce((sum, paymentId) => {
                const payment = currentPayments.find(p => p.id === paymentId);
                return sum + (payment ? payment.amount : 0);
            }, 0);

            const summaryElement = document.getElementById('calculatorSummary');

            if (selectedCount === 0) {
                summaryElement.textContent = 'Выберите платежи для подсчёта';
            } else {
                summaryElement.innerHTML =
                    `<span>${selectedCount} ${getCountWord(selectedCount)}: ${formatAmount(totalAmount)}</span>`;
            }
        }

        // Выбор платежей по пресету
        function selectByPreset(days) {
            selectedPayments.clear();

            currentPayments.forEach(payment => {
                if (payment.income) return;

                const state = paymentStates[payment.id] || { planned: false, paid: false };
                if (state.paid || state.planned) return;

                if (payment.daysDiff <= days) {
                    selectedPayments.add(payment.id);
                }
            });

            updateCalculator();
            renderPayments();
        }

        // Переключение режима калькулятора
        function toggleCalculatorMode() {
            calculatorMode = !calculatorMode;
            const toggleBtn = document.getElementById('calculatorToggle');
            const panel = document.getElementById('calculatorPanel');
            const paymentsList = document.getElementById('paymentsList');

            if (calculatorMode) {
                toggleBtn.classList.add('active');
                panel.classList.add('active');
                paymentsList.classList.add('calculator-mode');
                selectedPayments.clear();
                updateCalculator();
            } else {
                toggleBtn.classList.remove('active');
                panel.classList.remove('active');
                paymentsList.classList.remove('calculator-mode');
                selectedPayments.clear();
            }

            renderPayments();
        }

        // Рендер платежей
        function renderPayments() {
            const container = document.getElementById('paymentsList');
            container.innerHTML = '';

            currentPayments = generateAllPayments();
            const monthGroups = groupPaymentsByMonth(currentPayments);

            monthGroups.forEach((group, groupIndex) => {
                // Заголовок месяца
                const monthHeader = document.createElement('div');
                monthHeader.className = 'month-header';
                monthHeader.innerHTML = `
                    <div class="month-title">
                        ${group.monthName} ${group.year}
                    </div>
                `;
                container.appendChild(monthHeader);

                // Группа платежей
                const groupDiv = document.createElement('div');
                groupDiv.className = 'payment-group';

                group.payments.forEach((payment, index) => {
                    const paymentId = payment.id;
                    const state = paymentStates[paymentId] || { planned: false, paid: false };
                    const isSelected = selectedPayments.has(paymentId);

                    const div = document.createElement('div');
                    div.className = 'payment';
                    div.style.setProperty('--item-index', groupIndex * 10 + index);

                    if (payment.income) {
                        div.classList.add('income');
                    }

                    if (state.planned) {
                        div.classList.add('planned');
                    }

                    if (state.paid) {
                        div.classList.add('paid');
                    }

                    if (isSelected) {
                        div.classList.add('calculator-selected');
                    }

                    // Сумма платежа
                    let amountContent = '';
                    if (payment.income) {
                        amountContent = `
                            <div class="income-amount">Доход</div>
                        `;
                    } else {
                        const amountClass = payment.amount >= 10000 ? 'high' : '';
                        amountContent = `
                            <div class="payment-amount ${amountClass}">
                                ${formatAmount(payment.amount)}
                            </div>
                        `;
                    }

                    div.innerHTML = `
                        ${calculatorMode ? `
                        <div class="calculator-checkbox ${isSelected ? 'checked' : ''}
                             ${payment.income ? 'disabled' : ''}"
                             data-id="${paymentId}"></div>
                        ` : ''}

                        <div class="payment-info">
                            <div class="payment-details">
                                <div class="payment-name" title="${payment.name}">
                                    ${payment.name}
                                </div>
                                <div class="payment-meta">
                                    <span class="payment-date">${formatDate(payment.date)}</span>
                                    <span class="payment-days">${getDaysText(payment.daysDiff)}</span>
                                </div>
                            </div>

                            <div class="payment-amount-container">
                                ${amountContent}

                                ${!calculatorMode && !payment.income ? `
                                <div class="payment-actions">
                                    <button class="action-btn ${state.planned ? 'planned' : ''}"
                                            data-id="${paymentId}"
                                            data-action="planned"
                                            title="${state.planned ? 'Отметить как неучтённое' : 'Учесть трату'}">
                                        <i class="fas fa-bookmark"></i>
                                    </button>
                                    <button class="action-btn ${state.paid ? 'paid' : ''}"
                                            data-id="${paymentId}"
                                            data-action="paid"
                                            title="${state.paid ? 'Отметить как непогашенное' : 'Погасить'}">
                                        <i class="fas fa-check"></i>
                                    </button>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                    `;

                    groupDiv.appendChild(div);
                });

                container.appendChild(groupDiv);
            });

            // Обработчики
            if (!calculatorMode) {
                document.querySelectorAll('.action-btn').forEach(btn => {
                    btn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        const paymentId = this.getAttribute('data-id');
                        const action = this.getAttribute('data-action');

                        if (!paymentStates[paymentId]) {
                            paymentStates[paymentId] = { planned: false, paid: false };
                        }

                        if (action === 'planned') {
                            paymentStates[paymentId].planned = !paymentStates[paymentId].planned;
                        } else if (action === 'paid') {
                            const newPaid = !paymentStates[paymentId].paid;
                            paymentStates[paymentId].paid = newPaid;
                            // если ставим галочку — автоматически включаем флажок
                            if (newPaid) {
                                paymentStates[paymentId].planned = true;
                            }
                        }

                        savePaymentStates();
                        renderPayments();
                    });
                });
            }

            if (calculatorMode) {
                document.querySelectorAll('.calculator-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('click', function(e) {
                        e.stopPropagation();
                        const paymentId = this.getAttribute('data-id');

                        const payment = currentPayments.find(p => p.id === paymentId);
                        if (payment && payment.income) return;

                        if (selectedPayments.has(paymentId)) {
                            selectedPayments.delete(paymentId);
                        } else {
                            selectedPayments.add(paymentId);
                        }

                        updateCalculator();
                        renderPayments();
                    });
                });

                document.querySelectorAll('.payment').forEach(paymentDiv => {
                    paymentDiv.addEventListener('click', function(e) {
                        if (!calculatorMode || e.target.closest('.calculator-checkbox')) return;

                        const checkbox = this.querySelector('.calculator-checkbox');
                        if (checkbox && !checkbox.classList.contains('disabled')) {
                            checkbox.click();
                        }
                    });
                });
            }
        }

        // Инициализация
        document.getElementById('calculatorToggle').addEventListener('click', toggleCalculatorMode);

        document.getElementById('clearSelection').addEventListener('click', function() {
            selectedPayments.clear();
            updateCalculator();
            renderPayments();
        });

        document.getElementById('exitCalculator').addEventListener('click', toggleCalculatorMode);

        // Пресеты
        document.querySelectorAll('.preset-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const days = parseInt(this.getAttribute('data-days'));
                selectByPreset(days);
            });
        });

        // Запуск
        renderPayments();

        // Настройка темы
        function updateTheme() {
            const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const style = document.createElement('style');
            style.textContent = `
                :root {
                    --background-rgb: ${isDark ? '32, 33, 36' : '255, 255, 255'};
                }
            `;
            document.head.appendChild(style);
            document.documentElement.setAttribute('data-theme', isDark ? 'dark' : 'light');
        }

        updateTheme();
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', updateTheme);
    </script>

    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js');
            });
        }
    </script>
</body>
</html>
