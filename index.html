<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no">
    <title>Debts App</title>
    <meta name="color-scheme" content="light dark">

    <link rel="stylesheet" href="assets/fontawesome/css/all.min.css">

    <link rel="manifest" href="/manifest.webmanifest">

    <!-- –¶–≤–µ—Ç —Å—Ç–∞—Ç—É—Å-–±–∞—Ä–∞ –∏ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö UI (Android + Chrome iOS) -->
    <meta name="theme-color" content="#141821" media="(prefers-color-scheme: dark)">
    <meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)">

    <!-- iOS PWA full-screen -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <!-- –í–∞—Ä–∏–∞–Ω—Ç—ã: default / black / black-translucent. –î–ª—è Dynamic Island —á–∞—â–µ –ª—É—á—à–µ translucent -->
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <meta name="apple-mobile-web-app-title" content="Debts App">

    <!-- iOS –∏–∫–æ–Ω–∫–∏ -->
    <link rel="apple-touch-icon" href="icons/apple-touch-icon-180.png" sizes="180x180">
    <link rel="apple-touch-icon" href="icons/apple-touch-icon-167.png" sizes="167x167">
    <link rel="apple-touch-icon" href="icons/apple-touch-icon-152.png" sizes="152x152">
    <link rel="apple-touch-icon" href="icons/apple-touch-icon-120.png" sizes="120x120">

    <style>
        :root {
            --primary: #6366F1;
            --primary-light: #818CF8;
            --background: #F8FAFC;
            --surface: #FFFFFF;
            --text-primary: #1E293B;
            --text-secondary: #64748B;
            --text-tertiary: #94A3B8;
            --border: #E2E8F0;
            --success: #10B981;
            --danger: #EF4444;
            --warning: #F59E0B;
            --radius: 16px;
            --shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --background: #0F172A;
                --surface: #1E293B;
                --text-primary: #F1F5F9;
                --text-secondary: #94A3B8;
                --text-tertiary: #475569;
                --border: #334155;
                --shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
            }
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        body {
            background-color: var(--background);
            color: var(--text-primary);
            padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .container {
            max-width: 430px;
            margin: 0 auto;
            padding: 24px;
            width: 100%;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        /* –ó–∞–≥–æ–ª–æ–≤–æ–∫ */
        .header {
            margin-bottom: 24px;
            padding-top: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-primary);
            letter-spacing: -0.5px;
            flex: 1;
        }

        .header-actions {
            display: flex;
            gap: 12px;
        }

        .icon-button {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 20px;
            width: 40px;
            height: 40px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .icon-button.active {
            background-color: var(--primary);
            color: white;
        }

        .icon-button:active {
            background-color: var(--border);
        }

        /* –ü—Ä–æ–≥—Ä–µ—Å—Å */
        .progress-section {
            background: var(--surface);
            border-radius: var(--radius);
            padding: 24px;
            margin-bottom: 24px;
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .progress-section:active {
            transform: scale(0.98);
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .progress-title {
            font-size: 16px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .progress-amount {
            font-size: 20px;
            font-weight: 700;
            color: var(--primary);
        }

        .progress-bar {
            height: 8px;
            background-color: var(--border);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 16px;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--primary-light));
            border-radius: 4px;
            width: 100%;
            transition: width 1s cubic-bezier(0.4, 0, 0.2, 1);
            transform-origin: right center;
        }

        .progress-info {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        /* –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä */
        .calculator-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--surface);
            border-top: 1px solid var(--border);
            padding: 16px 24px;
            max-width: 430px;
            margin: 0 auto;
            transform: translateY(100%);
            transition: transform 0.3s ease;
            z-index: 100;
            padding-bottom: calc(16px + env(safe-area-inset-bottom));
        }

        .calculator-footer.active {
            transform: translateY(0);
        }

        .calculator-sum {
            text-align: center;
            font-size: 18px;
            font-weight: 700;
            color: var(--primary);
        }

        /* –°–ø–∏—Å–æ–∫ –ø–ª–∞—Ç–µ–∂–µ–π */
        .payments-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            margin-bottom: 80px; /* –û—Ç—Å—Ç—É–ø –¥–ª—è –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞ */
        }

        .section-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 20px;
            color: var(--text-primary);
            letter-spacing: -0.5px;
        }

        .payments-list {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding-right: 4px;
        }

        .payments-list::-webkit-scrollbar {
            width: 4px;
        }

        .payments-list::-webkit-scrollbar-track {
            background: var(--border);
            border-radius: 2px;
        }

        .payments-list::-webkit-scrollbar-thumb {
            background: var(--text-tertiary);
            border-radius: 2px;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö –ø–ª–∞—à–µ–∫ */
        .info-item {
            padding: 16px 20px;
            border-radius: var(--radius);
            margin: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
        }

        .today-item {
            background: linear-gradient(135deg, #6366F1, #818CF8);
            color: white;
            border: 1px solid rgba(99, 102, 241, 0.3);
        }

        .salary-item {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
            border: 1px solid rgba(16, 185, 129, 0.2);
        }

        .advance-item {
            background: rgba(139, 92, 246, 0.1);
            color: #8B5CF6;
            border: 1px solid rgba(139, 92, 246, 0.2);
        }

        @media (prefers-color-scheme: dark) {
            .today-item {
                background: linear-gradient(135deg, #6366F1, #818CF8);
                border-color: rgba(99, 102, 241, 0.5);
            }
            .salary-item {
                background: rgba(16, 185, 129, 0.2);
                border-color: rgba(16, 185, 129, 0.3);
            }
            .advance-item {
                background: rgba(139, 92, 246, 0.2);
                border-color: rgba(139, 92, 246, 0.3);
            }
        }

        .payment-item {
            background-color: var(--surface);
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-radius: var(--radius);
            border: 1px solid var(--border);
            transition: all 0.2s ease;
            box-shadow: var(--shadow);
            cursor: pointer;
            position: relative;
        }

        .payment-item.selected {
            border-color: var(--primary);
            background-color: rgba(99, 102, 241, 0.05);
        }

        .payment-item.checked .payment-name {
            text-decoration: line-through;
            opacity: 0.6;
        }

        .payment-item.checked .payment-amount {
            text-decoration: line-through;
            opacity: 0.6;
        }

        .payment-item:active {
            transform: scale(0.98);
        }

        .payment-info {
            display: flex;
            flex-direction: column;
            gap: 6px;
            flex: 1;
        }

        .payment-name {
            font-size: 17px;
            font-weight: 600;
            color: var(--text-primary);
            transition: all 0.2s ease;
        }

        .payment-meta {
            display: flex;
            gap: 16px;
            align-items: center;
        }

        .payment-date {
            font-size: 15px;
            font-weight: 500;
        }

        .payment-days {
            font-size: 14px;
            font-weight: 600;
            padding: 2px 8px;
            border-radius: 12px;
        }

        .days-danger {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }

        .days-warning {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }

        .days-normal {
            background: rgba(100, 116, 139, 0.1);
            color: var(--text-secondary);
        }

        .payment-amount {
            font-size: 18px;
            font-weight: 700;
        }

        .amount-high {
            color: var(--danger);
        }

        .amount-normal {
            color: var(--text-primary);
        }

        .payment-checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid var(--border);
            border-radius: 6px;
            margin-right: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }

        .payment-item.checked .payment-checkbox {
            background: var(--success);
            border-color: var(--success);
        }

        .payment-item.checked .payment-checkbox::after {
            content: '‚úì';
            color: white;
            font-size: 12px;
            font-weight: bold;
        }

        .edit-button {
            background: none;
            border: none;
            color: var(--text-tertiary);
            font-size: 16px;
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            margin-left: 12px;
            transition: all 0.2s ease;
        }

        .edit-button:active {
            background-color: var(--border);
            color: var(--text-primary);
        }

        /* –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--surface);
            border-radius: var(--radius);
            padding: 24px;
            width: 100%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid var(--border);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .close-button {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 20px;
            cursor: pointer;
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-button:active {
            background-color: var(--border);
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border);
            border-radius: 12px;
            background: var(--background);
            color: var(--text-primary);
            font-size: 16px;
            -webkit-appearance: none;
            appearance: none;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .form-row {
            display: flex;
            gap: 12px;
        }

        .form-row .form-group {
            flex: 1;
        }

        .form-select {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border);
            border-radius: 12px;
            background: var(--background);
            color: var(--text-primary);
            font-size: 16px;
            -webkit-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 16px;
        }

        .form-select:focus {
            outline: none;
            border-color: var(--primary);
        }

        .button {
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .button-primary {
            background: var(--primary);
            color: white;
        }

        .button-primary:active {
            background: var(--primary-light);
        }

        .button-secondary {
            background: var(--border);
            color: var(--text-primary);
        }

        .button-secondary:active {
            background: var(--text-tertiary);
        }

        .button-danger {
            background: var(--danger);
            color: white;
        }

        .button-danger:active {
            background: #DC2626;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        .modal-actions .button {
            flex: 1;
        }

        .actions-row {
            display: flex;
            gap: 8px;
        }

        /* JSON —Ä–µ–¥–∞–∫—Ç–æ—Ä */
        .json-editor {
            width: 100%;
            height: 200px;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 12px;
            background: var(--background);
            color: var(--text-primary);
            font-family: 'Courier New', monospace;
            font-size: 14px;
            resize: vertical;
        }

        /* –ê–Ω–∏–º–∞—Ü–∏–∏ */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .progress-section, .payment-item {
            animation: fadeIn 0.5s ease forwards;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>–£—á–µ—Ç –¥–æ–ª–≥–æ–≤</h1>
            <div class="header-actions">
                <button class="icon-button" id="calculatorButton">
                    <i class="fas fa-calculator"></i>
                </button>
                <button class="icon-button" id="settingsButton">
                    <i class="fas fa-sliders-h"></i>
                </button>
                <button class="icon-button" id="addButton" style="display:none;">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
        </div>

        <div class="progress-section" id="progressSection">
            <div class="progress-header">
                <div class="progress-title">–û—Å—Ç–∞–ª–æ—Å—å –≤—ã–ø–ª–∞—Ç–∏—Ç—å</div>
                <div class="progress-amount" id="remainingAmount">229 000 ‚ÇΩ</div>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-info">
                <div id="paidAmount">–í—ã–ø–ª–∞—á–µ–Ω–æ: 0 ‚ÇΩ</div>
                <div id="paidPercent">0%</div>
            </div>
        </div>

        <div class="payments-section">
            <div class="section-title">–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–µ–π</div>
            <div class="payments-list" id="paymentsList">
                <!-- –ü–ª–∞—Ç–µ–∂–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è —á–µ—Ä–µ–∑ JavaScript -->
            </div>
        </div>
    </div>

    <!-- –§—É—Ç–µ—Ä –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞ -->
    <div class="calculator-footer" id="calculatorFooter">
        <div class="calculator-sum" id="calculatorSum">0 ‚ÇΩ</div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞ -->
    <div class="modal" id="paymentModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="paymentModalTitle">–î–æ–±–∞–≤–∏—Ç—å –ø–ª–∞—Ç–µ–∂</h3>
                <button class="close-button" id="closePaymentModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="paymentForm">
                <input type="hidden" id="paymentId">
                <div class="form-group">
                    <label class="form-label">–¢–∏–ø –¥–æ–ª–≥–∞</label>
                    <select class="form-select" id="debtType" required>
                        <option value="fixed">–§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—É–º–º–∞</option>
                        <option value="installment">–ö—Ä–µ–¥–∏—Ç —Å –ø–ª–∞—Ç–µ–∂–∞–º–∏</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                    <input type="text" class="form-input" id="paymentName" required>
                </div>

                <div id="fixedDebtFields">
                    <div class="form-group">
                        <label class="form-label">–û–±—â–∞—è —Å—É–º–º–∞ –¥–æ–ª–≥–∞ (‚ÇΩ)</label>
                        <input type="number" class="form-input" id="totalDebt">
                    </div>
                </div>

                <div id="installmentDebtFields" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">–°—É–º–º–∞ –ø–ª–∞—Ç–µ–∂–∞ (‚ÇΩ)</label>
                        <input type="number" class="form-input" id="installmentAmount">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">–î–∞—Ç–∞ –ø–ª–∞—Ç–µ–∂–∞</label>
                        <input type="number" class="form-input" id="paymentDay" min="1" max="31" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">–°—É–º–º–∞ (‚ÇΩ)</label>
                        <input type="number" class="form-input" id="paymentAmount" required>
                    </div>
                </div>

                <div class="actions-row">
                    <button type="button" class="button button-secondary" id="cancelPayment">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="button button-primary" id="savePayment">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    <button type="button" class="button button-danger" id="deletePayment" style="display: none;">–£–¥–∞–ª–∏—Ç—å</button>
                </div>
            </form>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –¥–æ–ª–≥–∞ -->
    <div class="modal" id="debtSettingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–æ–ª–≥–∞</h3>
                <button class="close-button" id="closeDebtSettingsModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="form-group">
                <label class="form-label">–ù–∞—á–∞–ª—å–Ω—ã–π –¥–æ–ª–≥ (‚ÇΩ)</label>
                <input type="number" class="form-input" id="initialDebt" value="229000">
            </div>

            <div class="form-group">
                <label class="form-label">–¢–µ–∫—É—â–∏–π –¥–æ–ª–≥ (‚ÇΩ)</label>
                <input type="number" class="form-input" id="currentDebt" value="229000">
            </div>

            <div class="form-group">
                <label class="form-label">–í—ã—á–µ—Å—Ç—å —Å—É–º–º—É (‚ÇΩ)</label>
                <input type="number" class="form-input" id="subtractAmount" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –¥–ª—è –≤—ã—á–µ—Ç–∞">
            </div>

            <div class="modal-actions">
                <button type="button" class="button button-secondary" id="cancelDebtSettings">–û—Ç–º–µ–Ω–∞</button>
                <button type="button" class="button button-primary" id="saveDebtSettings">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–∫ -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
                <button class="close-button" id="closeSettingsModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="form-group">
                <label class="form-label">–ò–º–ø–æ—Ä—Ç/—ç–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</label>
                <textarea class="json-editor" id="jsonData"></textarea>
            </div>

            <div class="modal-actions">
                <button type="button" class="button button-secondary" id="exportData">–≠–∫—Å–ø–æ—Ä—Ç</button>
                <button type="button" class="button button-primary" id="importData">–ò–º–ø–æ—Ä—Ç</button>
            </div>
        </div>
    </div>

    <script>
        // –î–∞–Ω–Ω—ã–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        let debts = [];

        let calculatorMode = false;
        let selectedPayments = new Set();
        let initialTotalDebt = 229000;
        let currentTotalDebt = 229000;

        // DOM —ç–ª–µ–º–µ–Ω—Ç—ã
        const paymentsList = document.getElementById('paymentsList');
        const remainingAmount = document.getElementById('remainingAmount');
        const progressFill = document.getElementById('progressFill');
        const paidAmount = document.getElementById('paidAmount');
        const paidPercent = document.getElementById('paidPercent');
        const paymentModal = document.getElementById('paymentModal');
        const settingsModal = document.getElementById('settingsModal');
        const debtSettingsModal = document.getElementById('debtSettingsModal');
        const paymentForm = document.getElementById('paymentForm');
        const jsonData = document.getElementById('jsonData');
        const calculatorButton = document.getElementById('calculatorButton');
        const calculatorFooter = document.getElementById('calculatorFooter');
        const calculatorSum = document.getElementById('calculatorSum');
        const progressSection = document.getElementById('progressSection');

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        function init() {
            loadFromLocalStorage();
            renderPayments();
            updateProgress();
            updateJSONData();

            // –°–æ–±—ã—Ç–∏—è
            document.getElementById('addButton').addEventListener('click', () => {
                showPaymentModal();
            });

            document.getElementById('settingsButton').addEventListener('click', () => {
                settingsModal.classList.add('active');
            });

            progressSection.addEventListener('click', () => {
                showDebtSettingsModal();
            });

            calculatorButton.addEventListener('click', toggleCalculatorMode);

            document.getElementById('closePaymentModal').addEventListener('click', () => {
                paymentModal.classList.remove('active');
            });

            document.getElementById('closeSettingsModal').addEventListener('click', () => {
                settingsModal.classList.remove('active');
            });

            document.getElementById('closeDebtSettingsModal').addEventListener('click', () => {
                debtSettingsModal.classList.remove('active');
            });

            document.getElementById('cancelPayment').addEventListener('click', () => {
                paymentModal.classList.remove('active');
            });

            document.getElementById('cancelDebtSettings').addEventListener('click', () => {
                debtSettingsModal.classList.remove('active');
            });

            paymentForm.addEventListener('submit', function(e) {
                e.preventDefault();
                savePayment();
            });

            document.getElementById('deletePayment').addEventListener('click', deletePayment);

            document.getElementById('saveDebtSettings').addEventListener('click', saveDebtSettings);

            document.getElementById('exportData').addEventListener('click', exportData);
            document.getElementById('importData').addEventListener('click', importData);

            document.getElementById('debtType').addEventListener('change', toggleDebtTypeFields);
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑ localStorage
        function loadFromLocalStorage() {
            const saved = localStorage.getItem('debtsTracker');
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    debts = data.debts || debts;
                    calculatorMode = data.calculatorMode || false;
                    selectedPayments = new Set(data.selectedPayments || []);
                    initialTotalDebt = data.initialTotalDebt || 229000;
                    currentTotalDebt = data.currentTotalDebt || 229000;
                } catch (e) {
                    console.log('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ localStorage');
                }
            }
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ localStorage
        function saveToLocalStorage() {
            const data = {
                debts,
                calculatorMode,
                selectedPayments: Array.from(selectedPayments),
                initialTotalDebt,
                currentTotalDebt
            };
            localStorage.setItem('debtsTracker', JSON.stringify(data));
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –¥–æ–ª–≥–∞
        function showDebtSettingsModal() {
            document.getElementById('initialDebt').value = initialTotalDebt;
            document.getElementById('currentDebt').value = currentTotalDebt;
            document.getElementById('subtractAmount').value = '';
            debtSettingsModal.classList.add('active');
        }

        // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–æ–ª–≥–∞
        function saveDebtSettings() {
            const initialDebt = parseInt(document.getElementById('initialDebt').value);
            const currentDebt = parseInt(document.getElementById('currentDebt').value);
            const subtractAmount = parseInt(document.getElementById('subtractAmount').value) || 0;

            initialTotalDebt = initialDebt;
            currentTotalDebt = currentDebt - subtractAmount;

            if (currentTotalDebt < 0) currentTotalDebt = 0;

            updateProgress();
            saveToLocalStorage();
            debtSettingsModal.classList.remove('active');
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞
        function toggleCalculatorMode() {
            calculatorMode = !calculatorMode;
            calculatorButton.classList.toggle('active', calculatorMode);
            calculatorFooter.classList.toggle('active', calculatorMode);
            selectedPayments.clear();

            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–µ–π
            renderPayments();

            if (calculatorMode) {
                updateCalculatorSum();
            }
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –ø–æ–ª–µ–π –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –¥–æ–ª–≥–æ–≤
        function toggleDebtTypeFields() {
            const type = document.getElementById('debtType').value;
            document.getElementById('fixedDebtFields').style.display = type === 'fixed' ? 'block' : 'none';
            document.getElementById('installmentDebtFields').style.display = type === 'installment' ? 'block' : 'none';
        }

        // –†–µ–Ω–¥–µ—Ä —Å–ø–∏—Å–∫–∞ –ø–ª–∞—Ç–µ–∂–µ–π
        function renderPayments() {
            paymentsList.innerHTML = '';

            const today = new Date();
            const currentDay = today.getDate();
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();

            // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –ø–ª–∞—Ç–µ–∂–∏ –∏ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –ø–ª–∞—à–∫–∏
            const allItems = [];

            // –î–æ–±–∞–≤–ª—è–µ–º –ø–ª–∞—à–∫—É "—Å–µ–≥–æ–¥–Ω—è"
            const todayItem = {
                type: 'today',
                day: currentDay,
                name: '–°–µ–≥–æ–¥–Ω—è',
                amount: null
            };
            allItems.push(todayItem);

            // –î–æ–±–∞–≤–ª—è–µ–º –ø–ª–∞—à–∫—É –∑–∞—Ä–ø–ª–∞—Ç—ã (12 —á–∏—Å–ª–æ)
            const salaryItem = {
                type: 'salary',
                day: 12,
                name: 'üí≥ –ó–∞—Ä–ø–ª–∞—Ç–∞',
                amount: null
            };
            allItems.push(salaryItem);

            // –î–æ–±–∞–≤–ª—è–µ–º –ø–ª–∞—à–∫—É –∞–≤–∞–Ω—Å–∞ (27 —á–∏—Å–ª–æ)
            const advanceItem = {
                type: 'advance',
                day: 27,
                name: 'üíµ –ê–≤–∞–Ω—Å',
                amount: null
            };
            allItems.push(advanceItem);

            // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –ø–ª–∞—Ç–µ–∂–∏
            debts.forEach(debt => {
                debt.payments.forEach(payment => {
                    allItems.push({
                        type: 'payment',
                        ...payment,
                        debtId: debt.id,
                        debtName: debt.name,
                        debtType: debt.type
                    });
                });
            });

            // –§–∏–ª—å—Ç—Ä—É–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –ø–æ –¥–∞—Ç–µ (–æ—Ç –ø–æ–∑–∞–≤—á–µ—Ä–∞ –¥–æ +1 –º–µ—Å—è—Ü)
            const startDate = new Date(currentYear, currentMonth, currentDay - 2);
            const endDate = new Date(currentYear, currentMonth + 1, currentDay + 30);

            const filteredItems = allItems.filter(item => {
                if (item.type !== 'payment') return true;

                const paymentDate = new Date(currentYear, currentMonth, item.day);
                if (paymentDate < startDate) {
                    paymentDate.setMonth(paymentDate.getMonth() + 1);
                }
                return paymentDate >= startDate && paymentDate <= endDate;
            });

            // –°–æ—Ä—Ç–∏—Ä—É–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –ø–æ –¥–∞—Ç–µ
            filteredItems.sort((a, b) => a.day - b.day);

            filteredItems.forEach(item => {
                if (item.type === 'today') {
                    const todayElement = document.createElement('div');
                    todayElement.className = 'info-item today-item';
                    todayElement.innerHTML = `
                        <span>üìÖ –°–µ–≥–æ–¥–Ω—è</span>
                        <span>${currentDay} —á–∏—Å–ª–æ</span>
                    `;
                    paymentsList.appendChild(todayElement);
                } else if (item.type === 'salary') {
                    const salaryElement = document.createElement('div');
                    salaryElement.className = 'info-item salary-item';
                    salaryElement.innerHTML = `
                        <span>üí≥ –ó–∞—Ä–ø–ª–∞—Ç–∞</span>
                        <span>12 —á–∏—Å–ª–∞</span>
                    `;
                    paymentsList.appendChild(salaryElement);
                } else if (item.type === 'advance') {
                    const advanceElement = document.createElement('div');
                    advanceElement.className = 'info-item advance-item';
                    advanceElement.innerHTML = `
                        <span>üíµ –ê–≤–∞–Ω—Å</span>
                        <span>27 —á–∏—Å–ª–∞</span>
                    `;
                    paymentsList.appendChild(advanceElement);
                } else if (item.type === 'payment') {
                    const paymentDate = new Date(currentYear, currentMonth, item.day);
                    if (paymentDate < today) {
                        paymentDate.setMonth(paymentDate.getMonth() + 1);
                    }

                    const daysUntil = Math.ceil((paymentDate - today) / (1000 * 60 * 60 * 24));

                    let daysClass = 'days-normal';
                    if (daysUntil <= 4) {
                        daysClass = 'days-danger';
                    } else if (daysUntil <= 16) {
                        daysClass = 'days-warning';
                    }

                    const paymentItem = document.createElement('div');
                    paymentItem.className = `payment-item ${item.checked ? 'checked' : ''} ${selectedPayments.has(item.id) ? 'selected' : ''}`;
                    paymentItem.innerHTML = `
                        <div class="payment-checkbox"></div>
                        <div class="payment-info">
                            <div class="payment-name">${item.debtName}</div>
                            <div class="payment-meta">
                                <div class="payment-date">–î–æ ${item.day}</div>
                                <div class="payment-days ${daysClass}">—á–µ—Ä–µ–∑ ${daysUntil} –¥–Ω.</div>
                            </div>
                        </div>
                        <div class="payment-amount ${item.amount > 5000 ? 'amount-high' : 'amount-normal'}">
                            ${item.amount.toLocaleString()} ‚ÇΩ
                        </div>
                        <button class="edit-button" style="display: none">
                            <i class="fas fa-pen"></i>
                        </button>
                    `;

                    const checkbox = paymentItem.querySelector('.payment-checkbox');
                    const editButton = paymentItem.querySelector('.edit-button');

                    // paymentItem.addEventListener('click', (e) => {
                    //     e.stopPropagation();
                    //     togglePaymentChecked(item.id);
                    // });

                    checkbox.addEventListener('click', (e) => {
                        e.stopPropagation();
                        togglePaymentChecked(item.id);
                    });

                    editButton.addEventListener('click', (e) => {
                        e.stopPropagation();
                        showPaymentModal(item);
                    });

                    paymentItem.addEventListener('click', () => {
                        if (calculatorMode) {
                            togglePaymentSelection(item.id);
                        }
                    });

                    paymentsList.appendChild(paymentItem);
                }
            });
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≥–∞–ª–æ—á–∫–∏ –ø–ª–∞—Ç–µ–∂–∞
        function togglePaymentChecked(paymentId) {
            for (const debt of debts) {
                const payment = debt.payments.find(p => p.id === paymentId);
                if (payment) {
                    payment.checked = !payment.checked;
                    break;
                }
            }
            renderPayments();
            updateProgress();
            saveToLocalStorage();
        }

        // –í—ã–¥–µ–ª–µ–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞ –≤ —Ä–µ–∂–∏–º–µ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞
        function togglePaymentSelection(paymentId) {
            if (selectedPayments.has(paymentId)) {
                selectedPayments.delete(paymentId);
            } else {
                selectedPayments.add(paymentId);
            }
            renderPayments();
            updateCalculatorSum();
            saveToLocalStorage();
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—É–º–º—ã –≤ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–µ
        function updateCalculatorSum() {
            let total = 0;
            selectedPayments.forEach(paymentId => {
                const payment = findPaymentById(paymentId);
                if (payment) {
                    total += payment.amount;
                }
            });

            calculatorSum.textContent = `${total.toLocaleString()} ‚ÇΩ`;
        }

        // –ü–æ–∏—Å–∫ –ø–ª–∞—Ç–µ–∂–∞ –ø–æ ID
        function findPaymentById(paymentId) {
            for (const debt of debts) {
                const payment = debt.payments.find(p => p.id === paymentId);
                if (payment) return payment;
            }
            return null;
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–ª–∞—Ç–µ–∂–∞
        function showPaymentModal(payment = null) {
            const isEdit = !!payment;
            document.getElementById('paymentModalTitle').textContent = isEdit ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–ª–∞—Ç–µ–∂' : '–î–æ–±–∞–≤–∏—Ç—å –ø–ª–∞—Ç–µ–∂';
            document.getElementById('deletePayment').style.display = isEdit ? 'block' : 'none';

            if (isEdit) {
                const debt = debts.find(d => d.id === payment.debtId);
                document.getElementById('paymentId').value = payment.id;
                document.getElementById('debtType').value = debt.type;
                document.getElementById('paymentName').value = debt.name;
                document.getElementById('totalDebt').value = debt.totalAmount || '';
                document.getElementById('installmentAmount').value = debt.installmentAmount || '';
                document.getElementById('paymentDay').value = payment.day;
                document.getElementById('paymentAmount').value = payment.amount;

                toggleDebtTypeFields();
            } else {
                paymentForm.reset();
                document.getElementById('debtType').value = 'fixed';
                toggleDebtTypeFields();
            }

            paymentModal.classList.add('active');
        }

        // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–ª–∞—Ç–µ–∂
        function savePayment() {
            const id = document.getElementById('paymentId').value;
            const debtType = document.getElementById('debtType').value;
            const name = document.getElementById('paymentName').value;
            const day = parseInt(document.getElementById('paymentDay').value);
            const amount = parseInt(document.getElementById('paymentAmount').value);

            if (id) {
                // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–ª–∞—Ç–µ–∂–∞
                const payment = findPaymentById(parseInt(id));
                if (payment) {
                    const debt = debts.find(d => d.id === payment.debtId);
                    debt.name = name;
                    debt.type = debtType;

                    if (debtType === 'fixed') {
                        debt.totalAmount = parseInt(document.getElementById('totalDebt').value);
                    } else {
                        debt.installmentAmount = parseInt(document.getElementById('installmentAmount').value);
                    }

                    payment.day = day;
                    payment.amount = amount;
                }
            } else {
                // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –¥–æ–ª–≥–∞ –∏ –ø–ª–∞—Ç–µ–∂–∞
                const newDebt = {
                    id: Date.now(),
                    name,
                    type: debtType,
                    payments: [{ id: Date.now() + 1, day, amount, checked: false }]
                };

                if (debtType === 'fixed') {
                    newDebt.totalAmount = parseInt(document.getElementById('totalDebt').value);
                } else {
                    newDebt.installmentAmount = parseInt(document.getElementById('installmentAmount').value);
                }

                debts.push(newDebt);
            }

            renderPayments();
            updateProgress();
            updateJSONData();
            saveToLocalStorage();
            paymentModal.classList.remove('active');
        }

        // –£–¥–∞–ª–∏—Ç—å –ø–ª–∞—Ç–µ–∂
        function deletePayment() {
            const paymentId = parseInt(document.getElementById('paymentId').value);
            const payment = findPaymentById(paymentId);

            if (payment) {
                const debtIndex = debts.findIndex(d => d.id === payment.debtId);
                if (debtIndex !== -1) {
                    debts.splice(debtIndex, 1);
                }
            }

            renderPayments();
            updateProgress();
            updateJSONData();
            saveToLocalStorage();
            paymentModal.classList.remove('active');
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
        function updateProgress() {
            const paid = initialTotalDebt - currentTotalDebt;
            const percent = Math.round((paid / initialTotalDebt) * 100);

            remainingAmount.textContent = `${currentTotalDebt.toLocaleString()} ‚ÇΩ`;
            paidAmount.textContent = `–í—ã–ø–ª–∞—á–µ–Ω–æ: ${paid.toLocaleString()} ‚ÇΩ`;
            paidPercent.textContent = `${percent}%`;

            setTimeout(() => {
                progressFill.style.width = `${100 - percent}%`;
            }, 500);
        }

        // –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö
        function exportData() {
            const data = {
                debts,
                calculatorMode,
                selectedPayments: Array.from(selectedPayments),
                initialTotalDebt,
                currentTotalDebt
            };
            jsonData.value = JSON.stringify(data, null, 2);
        }

        // –ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö
        function importData() {
            try {
                const data = JSON.parse(jsonData.value);
                debts = data.debts || [];
                calculatorMode = data.calculatorMode || false;
                selectedPayments = new Set(data.selectedPayments || []);
                initialTotalDebt = data.initialTotalDebt || 229000;
                currentTotalDebt = data.currentTotalDebt || 229000;

                renderPayments();
                updateProgress();
                saveToLocalStorage();

                calculatorButton.classList.toggle('active', calculatorMode);
                calculatorFooter.classList.toggle('active', calculatorMode);

                settingsModal.classList.remove('active');
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ –¥–∞–Ω–Ω—ã—Ö. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–æ—Ä–º–∞—Ç JSON.');
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ JSON –¥–∞–Ω–Ω—ã—Ö
        function updateJSONData() {
            const data = {
                debts,
                calculatorMode,
                selectedPayments: Array.from(selectedPayments),
                initialTotalDebt,
                currentTotalDebt
            };
            jsonData.value = JSON.stringify(data, null, 2);
        }

        // –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        document.addEventListener('DOMContentLoaded', init);
    </script>

    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js');
            });
        }
    </script>
</body>
</html>
